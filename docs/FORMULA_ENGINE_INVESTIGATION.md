# üî¨ Formula Engine Investigation & Debug

**Date:** October 5, 2025  
**Issue:** –§–æ—Ä–º—É–ª—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (0 –≤–º–µ—Å—Ç–æ —Å—É–º–º—ã)  
**Goal:** –ü–æ–ª–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## üìã –°–∏–º–ø—Ç–æ–º—ã

1. `=SUM(A1:B1)` –≥–¥–µ A1=5, B1=3 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0` (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `8`)
2. –î—Ä—É–≥–∏–µ —Ñ–æ—Ä–º—É–ª—ã —Ç–æ–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
3. –ü–æ–ø—ã—Ç–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –≤ —á–∏—Å–ª–∞
   - ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω HyperFormula (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
   - ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è

---

## üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ 1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è:

**WorkbookModel:**
```typescript
interface WorkbookModel {
  sheets: SheetModel[];
}

interface SheetModel {
  id: string;
  name: string;
  cells: Map<string, CellData>;  // key: "row-col"
}

interface CellData {
  row: number;
  col: number;
  type: 's' | 'n' | 'b' | 'str';
  value: string | number | boolean | null;
  formula?: string;  // –ë–µ–∑ –∑–Ω–∞–∫–∞ "="
  style?: CellStyle;
}
```

### HyperFormula –æ–∂–∏–¥–∞–µ—Ç:

```typescript
// –ê–¥—Ä–µ—Å —è—á–µ–π–∫–∏
SimpleCellAddress = { sheet: number, col: number, row: number }

// –ó–Ω–∞—á–µ–Ω–∏—è
setCellContents(address, value)
// value –º–æ–∂–µ—Ç –±—ã—Ç—å:
// - number: 5
// - string: "hello"
// - formula string: "=SUM(A1:B1)"  ‚Üê –° –ó–ù–ê–ö–û–ú "="!
```

---

## üêõ –ì–∏–ø–æ—Ç–µ–∑–∞ 1: –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π

**HyperFormula:**
- row: 0-based (0, 1, 2, ...)
- col: 0-based (0=A, 1=B, 2=C, ...)

**–ù–∞—à Workbook:**
- row: 1-based? (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
- col: 1-based? (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

**‚ùó –ö–†–ò–¢–ò–ß–ù–û:** –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤, HyperFormula —á–∏—Ç–∞–µ—Ç –Ω–µ —Ç–µ —è—á–µ–π–∫–∏!

---

## üêõ –ì–∏–ø–æ—Ç–µ–∑–∞ 2: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
// –í getCellDisplayValue –≤—ã–∑—ã–≤–∞–µ–º:
syncSheetToHyperFormula(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –í–°–ï —è—á–µ–π–∫–∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑

// –ù–æ —á—Ç–æ –µ—Å–ª–∏:
// 1. –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ workbook?
// 2. workbookRef.current —É—Å—Ç–∞—Ä–µ–ª?
// 3. cells.forEach –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–µ –ø–æ —Ç–µ–º –¥–∞–Ω–Ω—ã–º?
```

---

## üêõ –ì–∏–ø–æ—Ç–µ–∑–∞ 3: –§–æ—Ä–º–∞—Ç —Ñ–æ—Ä–º—É–ª—ã

**–í CellData.formula —Ö—Ä–∞–Ω–∏—Ç—Å—è:** `SUM(A1:B1)` (–ë–ï–ó "=")

**–ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è–µ–º "=":**
```typescript
hf.setCellContents(address, `=${cellData.formula}`);
```

**–ù–æ —á—Ç–æ –µ—Å–ª–∏:**
- –§–æ—Ä–º—É–ª–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "="?
- –§–æ—Ä–º—É–ª–∞ –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å?
- HyperFormula –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç?

---

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 1: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä HyperFormula

–°–æ–∑–¥–∞–¥–∏–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç:

```typescript
import { HyperFormula } from 'hyperformula';

// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
const hf = HyperFormula.buildEmpty({
  licenseKey: 'gpl-v3',
});
hf.addSheet('Sheet1');

// 2. –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
hf.setCellContents({ sheet: 0, col: 0, row: 0 }, 5);     // A1 = 5
hf.setCellContents({ sheet: 0, col: 1, row: 0 }, 3);     // B1 = 3
hf.setCellContents({ sheet: 0, col: 2, row: 0 }, '=SUM(A1:B1)'); // C1 = formula

// 3. –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
const result = hf.getCellValue({ sheet: 0, col: 2, row: 0 });
console.log('Result:', result); // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 8
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `8`  
**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –ü—Ä–æ–±–ª–µ–º–∞ –≤ –±–∞–∑–æ–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ HyperFormula

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤

```typescript
// –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –Ω–∞—à–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:
workbook.sheets[0].cells.set('0-0', {
  row: 0,
  col: 0,
  type: 'n',
  value: 5
});

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
syncSheetToHyperFormula();

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ HyperFormula –≤–∏–¥–∏—Ç:
const hfValue = hf.getCellValue({ sheet: 0, col: 0, row: 0 });
console.log('HF sees:', hfValue); // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 5
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```typescript
// –î–æ–±–∞–≤–ª—è–µ–º debug –ª–æ–≥–∏ –≤ syncSheetToHyperFormula:
currentSheet.cells.forEach((cellData, key) => {
  const [row, col] = key.split('-').map(Number);
  console.log(`Syncing cell ${key}:`, {
    row,
    col,
    value: cellData.value,
    formula: cellData.formula
  });
  
  const address: SimpleCellAddress = { sheet: 0, col, row };
  
  if (cellData.formula) {
    console.log(`  Setting formula: =${cellData.formula}`);
    hf.setCellContents(address, `=${cellData.formula}`);
  } else {
    console.log(`  Setting value:`, cellData.value);
    hf.setCellContents(address, cellData.value);
  }
});
```

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï –ù–ê–ô–î–ï–ù–û!

**–î–∞—Ç–∞:** October 5, 2025  
**Root Cause:** –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –º–µ–∂–¥—É workbook –∏ HyperFormula

### –ü—Ä–æ–±–ª–µ–º–∞

**–ù–∞—à workbook –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 1-based –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:**
- A1 = `row:1, col:1`
- A2 = `row:2, col:1`
- B2 = `row:2, col:2`

**HyperFormula –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 0-based –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:**
- A1 = `row:0, col:0`
- A2 = `row:1, col:0`
- B2 = `row:1, col:1`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. –ó–∞–ø–∏—Å—ã–≤–∞–ª–∏ `1` –≤ HyperFormula –Ω–∞ `{row:2, col:1}`
2. –î–ª—è HyperFormula —ç—Ç–æ —è—á–µ–π–∫–∞ **C3**, –∞ –Ω–µ A2!
3. –§–æ—Ä–º—É–ª–∞ `=SUM(A2:B2)` –∏—Å–∫–∞–ª–∞ —è—á–µ–π–∫–∏ `{row:1, col:0-1}`
4. –≠—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏ –±—ã–ª–∏ –ø—É—Å—Ç—ã–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç 0

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

```typescript
// Convert 1-based to 0-based indexing for HyperFormula
const hfRow = row - 1;
const hfCol = col - 1;
const address: SimpleCellAddress = { sheet: 0, col: hfCol, row: hfRow };
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –§–æ—Ä–º—É–ª—ã —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
- `=SUM(A1:B1)` ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞
- `=AVERAGE(A1:A10)` ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ
- –í—Å–µ 380+ —Ñ—É–Ω–∫—Ü–∏–π HyperFormula —Ä–∞–±–æ—Ç–∞—é—Ç!

---

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ A: –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HyperFormula –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

### –†–µ—à–µ–Ω–∏–µ B: –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É –ø–∞—Ä—Å–µ—Ä—É
- –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞—à formula-parser.ts
- –£–±—Ä–∞—Ç—å HyperFormula (—ç–∫–æ–Ω–æ–º–∏—è 561kb)
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ª–æ–≥–∏–∫–æ–π

### –†–µ—à–µ–Ω–∏–µ C: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HyperFormula
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API

---

## üìä –ß–µ–∫–ª–∏—Å—Ç –æ—Ç–ª–∞–¥–∫–∏

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é (0-based vs 1-based)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–µ–π –≤ Map ("0-0" vs "1-1")
- [ ] –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ syncSheetToHyperFormula
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HyperFormula –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å timing —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ workbookRef.current –∞–∫—Ç—É–∞–ª–µ–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ñ–æ—Ä–º—É–ª (—Å "=" –∏–ª–∏ –±–µ–∑)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (string "5" vs number 5)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—Å—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ
- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é HyperFormula –ø–æ–ª–Ω–æ—Å—Ç—å—é

---

## üéØ Next Steps

1. –î–æ–±–∞–≤–∏—Ç—å debug –≤–µ—Ä—Å–∏—é —Å –ª–æ–≥–∞–º–∏
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å
4. –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ö–æ–¥–∫–∏
5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
6. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
7. –û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

---

**Status:** üî¥ In Progress  
**Priority:** üî• Critical  
**Blocker:** Yes
